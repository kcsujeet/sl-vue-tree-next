(function(S,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],l):(S=typeof globalThis<"u"?globalThis:S||self,l(S.SLVueTreeNext={},S.Vue))})(this,function(S,l){"use strict";const ue=["onMousedown","onMouseup","onContextmenu","onDblclick","onClick","onDragover","onDrop","path"],fe={class:"sl-vue-tree-gap"},pe={key:0,class:"sl-vue-tree-branch"},me={key:0},ge={key:1},he={class:"sl-vue-tree-title"},Se=["onClick"],Ne={class:"sl-vue-tree-sidebar"},ye={slot:"title","slot-scope":"{ node }"},Ce={slot:"toggle","slot-scope":"{ node }"},ke={slot:"sidebar","slot-scope":"{ node }"},be={slot:"empty-node","slot-scope":"{ node }"},ve=l.defineComponent({__name:"SlVueTreeNext",props:{modelValue:{default:()=>[]},edgeSize:{default:3},allowMultiselect:{type:Boolean,default:!0},showBranches:{type:Boolean,default:!1},level:{default:0},parentInd:{default:void 0},parentContext:{},rootContext:{},allowToggleBranch:{type:Boolean,default:!0}},emits:["update:modelValue","select","beforedrop","drop","toggle","nodeclick","nodedblclick","updateNode","nodecontextmenu","externaldragover","externaldrop"],setup(Ee,{expose:De,emit:Be}){const d=Ee,K=Be,v=l.ref(),M=l.ref(),X=l.ref(null),x=l.ref(0),H=l.ref(0),V=l.ref(null),T=l.ref(!1),N=l.ref(!1),R=l.ref({x:0,y:0}),I=l.ref(!1),m=l.ref([]),p=l.computed(()=>!d.level),j=l.computed(()=>{const e=[];let t=d.level-1;for(d.showBranches||t++;t-- >0;)e.push(t);return e}),u=l.computed(()=>{var t;return p.value?X.value:(t=O())==null?void 0:t.cursorPosition.value}),U=l.computed(()=>j.value.length),L=l.computed(()=>{var t,r,o,s;if(p.value){const n=C(m.value);return q(n)}return d.parentInd===null?[]:(s=(o=(r=(t=O())==null?void 0:t.nodes)==null?void 0:r.value)==null?void 0:o[d.parentInd])==null?void 0:s.children}),we=l.computed(()=>re().length);l.computed(()=>F().length),l.onMounted(()=>{p.value&&document.addEventListener("mouseup",oe)}),l.onBeforeUnmount(()=>{document.removeEventListener("mouseup",oe)}),l.watchEffect(()=>{m.value=d.modelValue});const b=e=>{var t;if(p.value){X.value=e;return}(t=O())==null||t.setCursorPosition(e)},q=(e,t=[],r=!0)=>e.map((o,s)=>{const n=t.concat(s);return E(n,o,e,r)}),E=(e,t=null,r=null,o=!1)=>{const s=e.slice(-1)[0];if(r=r||P(m.value,e),t=t||r&&r[s]||null,o==null&&(o=$==null?void 0:$(e)),!t)return null;const n=t.isExpanded==null?!0:!!t.isExpanded,i=t.isDraggable==null?!0:!!t.isDraggable,a=t.isSelectable==null?!0:!!t.isSelectable;return{title:t.title,isLeaf:!!t.isLeaf,children:t.children?q(t.children,e,n):[],isSelected:!!t.isSelected,isExpanded:n,visible:o,isDraggable:i,isSelectable:a,data:t.data!==void 0?t.data:{},path:e,pathStr:JSON.stringify(e),level:e.length,ind:s,isFirstChild:s==0,isLastChild:s==((r==null?void 0:r.length)??0)-1}},$=e=>{if(e.length<2)return!0;let t=m.value;for(let r=0;r<e.length-1;r++){let o=e[r],s=t[o];if(!(s.isExpanded==null?!0:!!s.isExpanded))return!1;t=s.children||[]}return!0},D=e=>{Object.assign(m.value,e),f().emit("update:modelValue",e)},xe=(e,t)=>{f().emit("select",e,t)},Ve=(e,t,r)=>{f().emit("beforedrop",e,t,r)},Te=(e,t,r)=>{f().emit("drop",e,t,r)},Ie=(e,t)=>{f().emit("toggle",e,t)},Le=(e,t)=>{f().emit("nodeclick",e,t)},Pe=(e,t)=>{f().emit("nodedblclick",e,t)},_e=(e,t)=>{f().emit("nodecontextmenu",e,t)},He=(e,t)=>{t.preventDefault();const r=f(),o=r.getCursorPositionFromCoords(t.clientX,t.clientY);r.setCursorPosition(o),r.emit("externaldragover",o,t)},Re=(e,t)=>{const r=f(),o=r.getCursorPositionFromCoords(t.clientX,t.clientY);r.emit("externaldrop",o,t),b(null)},W=(e,t=!1,r=null)=>{const o=Array.isArray(d.multiselectKey)?d.multiselectKey:[d.multiselectKey];t=(r&&!!o.find(h=>r[h])||t)&&d.allowMultiselect;const n=E(e);if(!n)return null;const i=C(m.value),a=d.allowMultiselect&&r&&r.shiftKey&&V.value,c=[];let g=!1;return y((h,k)=>{var w;a?((h.pathStr===n.pathStr||h.pathStr===((w=V.value)==null?void 0:w.pathStr))&&(k.isSelected=h.isSelectable,g=!g),g&&(k.isSelected=h.isSelectable)):h.pathStr===n.pathStr?k.isSelected=h.isSelectable:t||k.isSelected&&(k.isSelected=!1),k.isSelected&&c.push(h)},i),V.value=n,D(i),xe(c,r),n},G=e=>{var ce,de;if(!p.value){(ce=f())==null||ce.onMousemoveHandler(e);return}if(I.value)return;const t=N.value,r=t||T.value&&(R.value.x!==e.clientX||R.value.y!==e.clientY),o=t===!1&&r===!0;if(R.value={x:e.clientX,y:e.clientY},!r)return;const s=f().ref.value,n=s.getBoundingClientRect(),i=e.clientY-n.top+s.scrollTop-Number(((de=v.value)==null?void 0:de.style.marginBottom)??0),a=e.clientX-n.left;v.value&&(v.value.style.top=i+"px",v.value.style.left=a+"px");const c=Q(e.clientX,e.clientY),g=c==null?void 0:c.node,h=c==null?void 0:c.placement;if(o&&!g.isSelected&&W(g.path,!1,e),!F().length){I.value=!0;return}N.value=r,b({node:g,placement:h});const w=n.bottom-d.scrollAreaHeight,se=(e.clientY-w)/(n.bottom-w),ae=n.top+d.scrollAreaHeight,ie=(ae-e.clientY)/(ae-n.top);se>0?le(se):ie>0?le(-ie):z()},Q=(e,t)=>{const r=document.elementFromPoint(e,t),o=r!=null&&r.getAttribute("path")?r:Z(r);let s,n;if(o){if(!o)return;s=E(JSON.parse(o.getAttribute("path")));const i=o.offsetHeight,a=d.edgeSize,c=t-o.getBoundingClientRect().top;s.isLeaf?n=c>=i/2?"after":"before":c<=a?n="before":c>=i-a?n="after":n="inside"}else{const a=f().ref.value.getBoundingClientRect();t>a.top+a.height/2?(n="after",s=ze()):(n="before",s=ee())}return{node:s,placement:n}},Z=e=>e?e.getAttribute("path")?e:Z(e.parentElement):null,$e=e=>{if(!p.value||!N.value)return;const r=f().ref.value.getBoundingClientRect();e.clientY>=r.bottom?b({node:L.value.slice(-1)[0],placement:"after"}):e.clientY<r.top&&b({node:ee(),placement:"before"})},ze=()=>{let e=null;return y(t=>{e=t}),e},ee=()=>E([0]),te=(e,t)=>{if(e.button===0){if(!p.value){f().onNodeMousedownHandler(e,t);return}T.value=!0}},le=e=>{const t=f().ref.value;H.value!==e&&(x.value&&z(),H.value=e,x.value=setInterval(()=>{t.scrollTop+=d.maxScrollSpeed*e},20))},z=()=>{clearInterval(x.value),x.value=0,H.value=0},oe=e=>{N.value&&Y(e)},Y=(e,t=null)=>{if(e.button!==0)return;if(!p.value){f().onNodeMouseupHandler(e,t);return}if(T.value=!1,!N.value&&t&&!I.value&&W(t.path,!1,e),I.value=!1,!u.value){B();return}const r=F();for(let a of r){if(a.pathStr==u.value.node.pathStr){B();return}if(Fe(a,u.value.node)){B();return}}const o=C(m.value),s=[];for(let a of r){const g=P(o,a.path)[a.ind];s.push(g)}let n=!1;if(Ve(r,u.value,()=>n=!0),n){B();return}const i=[];for(let a of s)i.push(C(a)),a._markToDelete=!0;ne(u.value,i,o),J((a,c,g)=>{a._markToDelete&&c.splice(g,1)},o),V.value=null,D(o),Te(r,u.value,e),B()},Ye=(e,t)=>{d.allowToggleBranch&&(A({path:t.path,patch:{isExpanded:!t.isExpanded}}),Ie(t,e),e.stopPropagation())},B=()=>{N.value=!1,T.value=!1,b(null),z()},O=()=>d.parentContext,f=()=>p.value?_:d.rootContext,P=(e,t)=>t.length===1?e:P(e[t[0]].children,t.slice(1)),A=({path:e,patch:t})=>{p.value||K("updateNode",{path:e,patch:t});const r=JSON.stringify(e),o=C(m.value);y((s,n)=>{s.pathStr===r&&Object.assign(n,t)},o),D(o)},re=()=>{const e=[];return y(t=>{t.isSelected&&e.push(t)}),e},F=()=>{const e=[];return y(t=>{t.isSelected&&t.isDraggable&&e.push(t)}),e},y=(e,t=null,r=[])=>{t||(t=m.value);let o=!1;const s=[];for(let n=0;n<t.length;n++){const i=t[n],a=r.concat(n),c=E(a,i,t);if(o=e(c,i,t)===!1,c&&s.push(c),o||i.children&&(o=y(e,i.children,a)===!1,o))break}return o?!1:s},J=(e,t)=>{let r=t.length;for(;r--;){const o=t[r];o.children&&J(e,o.children),e(o,t,r)}return t},Oe=e=>{const t=e.map(o=>JSON.stringify(o)),r=C(m.value);y((o,s,n)=>{for(const i of t)o.pathStr===i&&(s._markToDelete=!0)},r),J((o,s,n)=>{o._markToDelete&&s.splice(n,1)},r),D(r)},ne=(e,t,r)=>{const o=e.node,s=P(r,o.path),n=s[o.ind];if(e.placement==="inside")n.children=n.children||[],n.children.unshift(...t);else{const i=e.placement==="before"?o.ind:o.ind+1;s.splice(i,0,...t)}},Ae=(e,t)=>{const r=Array.isArray(t)?t:[t],o=C(m.value);ne(e,r,o),D(o)},Fe=(e,t)=>{const r=t.path;return JSON.stringify(r.slice(0,e.path.length))==e.pathStr},C=e=>JSON.parse(JSON.stringify(e)),_={getRoot:f,setCursorPosition:b,nodes:L,cursorPosition:u,emit:K,ref:M,onNodeMousedownHandler:te,onNodeMouseupHandler:Y,onMousemoveHandler:G,getCursorPositionFromCoords:Q,updateNode:A,getSelected:re,insert:Ae,remove:Oe};return De(_),(e,t)=>{const r=l.resolveComponent("SlVueTreeNext",!0);return l.openBlock(),l.createElementBlock("div",{ref_key:"rootRef",ref:M,class:l.normalizeClass(["sl-vue-tree",{"sl-vue-tree-root":p.value}]),onMousemove:G,onMouseleave:$e},[l.createElementVNode("div",{ref_key:"nodes",ref:L,class:"sl-vue-tree-nodes-list"},[(l.openBlock(!0),l.createElementBlock(l.Fragment,null,l.renderList(L.value,(o,s)=>(l.openBlock(),l.createElementBlock("div",{class:l.normalizeClass(["sl-vue-tree-node",{"sl-vue-tree-selected":o.isSelected}])},[l.createElementVNode("div",{class:"sl-vue-tree-cursor sl-vue-tree-cursor_before",onDragover:t[0]||(t[0]=l.withModifiers(()=>{},["prevent"])),style:l.normalizeStyle({visibility:u.value&&u.value.node.pathStr===o.pathStr&&u.value.placement==="before"?"visible":"hidden","--depth":U.value})},null,36),l.createElementVNode("div",{class:l.normalizeClass(["sl-vue-tree-node-item",{"sl-vue-tree-cursor-hover":u.value&&u.value.node.pathStr===o.pathStr,"sl-vue-tree-cursor-inside":u.value&&u.value.placement==="inside"&&u.value.node.pathStr===o.pathStr,"sl-vue-tree-node-is-leaf":o.isLeaf,"sl-vue-tree-node-is-folder":!o.isLeaf}]),onMousedown:n=>te(n,o),onMouseup:n=>Y(n,o),onContextmenu:n=>_e(o,n),onDblclick:n=>Pe(o,n),onClick:n=>Le(o,n),onDragover:n=>He(o,n),onDrop:n=>Re(o,n),path:o.pathStr},[(l.openBlock(!0),l.createElementBlock(l.Fragment,null,l.renderList(j.value,n=>(l.openBlock(),l.createElementBlock("div",fe))),256)),e.level&&e.showBranches?(l.openBlock(),l.createElementBlock("div",pe,[l.renderSlot(e.$slots,"branch",{node:o},()=>[o.isLastChild?l.createCommentVNode("",!0):(l.openBlock(),l.createElementBlock("span",me,l.toDisplayString("├")+l.toDisplayString("─")+"  ",1)),o.isLastChild?(l.openBlock(),l.createElementBlock("span",ge,l.toDisplayString("└")+l.toDisplayString("─")+"  ",1)):l.createCommentVNode("",!0)])])):l.createCommentVNode("",!0),l.createElementVNode("div",he,[o.isLeaf?l.createCommentVNode("",!0):(l.openBlock(),l.createElementBlock("span",{key:0,class:"sl-vue-tree-toggle",onClick:n=>Ye(n,o)},[l.renderSlot(e.$slots,"toggle",{node:o},()=>[l.createElementVNode("span",null,l.toDisplayString(o.isLeaf?"":o.isExpanded?"-":"+"),1)])],8,Se)),l.renderSlot(e.$slots,"title",{node:o},()=>[l.createTextVNode(l.toDisplayString(o.title),1)]),!o.isLeaf&&o.children.length==0&&o.isExpanded?l.renderSlot(e.$slots,"empty-node",{key:1,node:o}):l.createCommentVNode("",!0)]),l.createElementVNode("div",Ne,[l.renderSlot(e.$slots,"sidebar",{node:o})])],42,ue),o.children&&o.children.length&&o.isExpanded?(l.openBlock(),l.createBlock(r,{key:0,"model-value":o.children,level:o.level,"parent-ind":s,"allow-multiselect":e.allowMultiselect,"allow-toggle-branch":e.allowToggleBranch,"edge-size":e.edgeSize,"show-branches":e.showBranches,"parent-context":_,"root-context":p.value?_:e.rootContext,onUpdateNode:A,onDragover:t[1]||(t[1]=l.withModifiers(()=>{},["prevent"]))},{default:l.withCtx(()=>[l.createElementVNode("template",ye,[l.renderSlot(e.$slots,"title",{node:o},()=>[l.createTextVNode(l.toDisplayString(o.title),1)])]),l.createElementVNode("template",Ce,[l.renderSlot(e.$slots,"toggle",{node:o},()=>[l.createElementVNode("span",null,l.toDisplayString(o.isLeaf?"":o.isExpanded?"-":"+"),1)])]),l.createElementVNode("template",ke,[l.renderSlot(e.$slots,"sidebar",{node:o})]),l.createElementVNode("template",be,[!o.isLeaf&&o.children.length==0&&o.isExpanded?l.renderSlot(e.$slots,"empty-node",{key:0,node:o}):l.createCommentVNode("",!0)])]),_:2},1032,["model-value","level","parent-ind","allow-multiselect","allow-toggle-branch","edge-size","show-branches","root-context"])):l.createCommentVNode("",!0),l.createElementVNode("div",{class:"sl-vue-tree-cursor sl-vue-tree-cursor_after",onDragover:t[2]||(t[2]=l.withModifiers(()=>{},["prevent"])),style:l.normalizeStyle({visibility:u.value&&u.value.node.pathStr===o.pathStr&&u.value.placement==="after"?"visible":"hidden","--depth":U.value})},null,36)],2))),256)),p.value?l.withDirectives((l.openBlock(),l.createElementBlock("div",{key:0,ref_key:"dragInfoRef",ref:v,class:"sl-vue-tree-drag-info"},[l.renderSlot(e.$slots,"draginfo",{},()=>[l.createTextVNode(" Items: "+l.toDisplayString(we.value),1)])],512)),[[l.vShow,N.value]]):l.createCommentVNode("",!0)],512)],34)}}});S.SlVueTreeNext=ve,Object.defineProperty(S,Symbol.toStringTag,{value:"Module"})});
